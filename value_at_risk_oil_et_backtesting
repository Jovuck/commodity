import yfinance as yf
import numpy as np
import pandas as pd

class RiskManager:
    def __init__(self, ticker):
        # 1. Download and strictly clean yfinance MultiIndex structure
        df = yf.download(ticker, start="2022-01-01")
        if isinstance(df.columns, pd.MultiIndex):
            self.data = df['Close'][ticker]
        else:
            self.data = df['Close']
            
        # 2. Calculate log-returns (dropping NaN values)
        self.returns = np.log(self.data / self.data.shift(1)).dropna()

    def backtest_var(self, confidence=0.95):
        """
        Performs a rolling Historical VaR backtest.
        - confidence: Confidence level (e.g., 0.95 for 95% VaR)
        - window: 252-day trading window (1 year)
        """
        window = 252
        
        # 3. Compute Rolling Historical VaR
        # We target the lower tail quantile (e.g., 0.05 for 95% confidence)
        var_series = self.returns.rolling(window=window).quantile(1 - confidence).dropna()
        
        # 4. Align returns with the VaR series index
        aligned_returns = self.returns.loc[var_series.index]
        
        # 5. CRITICAL TEST: A breach (exception) occurs when Return < VaR level
        # Since VaR is negative (e.g., -3%) and Return is more negative (e.g., -4%),
        # -0.04 < -0.03 is TRUE -> This is a VaR breach.
        exceptions = aligned_returns[aligned_returns < var_series]
        
        failure_rate = len(exceptions) / len(aligned_returns)
        
        return {
            "Confidence": confidence,
            "Total Days": len(aligned_returns),
            "Exceptions": len(exceptions),
            "Failure Rate": failure_rate,
            "Expected Rate": 1 - confidence,
            "Mean VaR": var_series.mean()
        }

# --- EXECUTION & BACKTESTING ---
risk = RiskManager("BZ=F") # Brent Crude Oil
for conf in [0.95, 0.99]:
    res = risk.backtest_var(conf)
    print(f"\n--- Results for {res['Confidence']*100:.0f}% VaR ---")
    print(f"Mean VaR Level   : {res['Mean VaR']:.2%}")
    print(f"Breaches Found   : {res['Exceptions']} / {res['Total Days']}")
    print(f"Real Failure Rate: {res['Failure Rate']:.2%}")
    
    # Status check based on acceptable deviation from the expected rate
    # For a 95% VaR, we expect a 5% failure rate.
    print(f"Status           : {'VALID' if res['Failure Rate'] < (res['Expected Rate'] * 1.5) else 'REVIEW REQUIRED'}")
